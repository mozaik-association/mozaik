<?xml version='1.0' encoding='UTF-8' ?>
<odoo noupdate="0">

    <record id="res_partner_search_view" model="ir.ui.view">
        <field name="name">res.partner.search (mozaik_membership)</field>
        <field name="model">res.partner</field>
        <field name="inherit_id" ref="base.view_res_partner_filter" />
        <field name="arch" type="xml">
            <xpath expr="//filter[1]" position="before">
                <field name="int_instance_ids" widget="many2one"/>
                <field name="subscription_product_id" />
                <field name="membership_state_id" />
                <field name="reference" />

                <filter string="Local Voluntary"
                    name="local_voluntary"
                    domain="[('local_voluntary','=', True)]"
                    invisible="'default_is_company' not in context or context.get('default_is_company')" />
                <filter string="Regional Voluntary"
                    name="regional_voluntary"
                    domain="[('regional_voluntary','=', True)]"
                    invisible="'default_is_company' not in context or context.get('default_is_company')" />
                <filter string="National Voluntary"
                    name="national_voluntary"
                    domain="[('national_voluntary','=', True)]"
                    invisible="'default_is_company' not in context or context.get('default_is_company')" />
                <filter string="Non Local Voluntary"
                    name="non_local_voluntary"
                    domain="[('local_voluntary','=', False)]"
                    invisible="'default_is_company' not in context or context.get('default_is_company')" />
                <filter string="Non Regional Voluntary"
                    name="non_regional_voluntary"
                    domain="[('regional_voluntary','=', False)]"
                    invisible="'default_is_company' not in context or context.get('default_is_company')" />
                <filter string="Non National Voluntary"
                    name="non_national_voluntary"
                    domain="[('national_voluntary','=', False)]"
                    invisible="'default_is_company' not in context or context.get('default_is_company')" />
                <separator/>
                <filter string="Local Only"
                    name="local_only"
                    domain="[('local_only','=', True)]" />
                <filter string="Not Local Only"
                    name="not_local_only"
                    domain="[('local_only','=', False)]" />
                <separator/>
                <filter string="Awaiting payment" name="awaiting_payment"
                    domain="[('reference','!=', False)]"
                    invisible="'default_is_company' not in context or context.get('default_is_company')" />
                <separator/>
            </xpath>
            <xpath expr="//filter[@name='group_country']" position="after">
                <filter name="group_membership_state" string="Membership State"
                    context="{'group_by': 'membership_state_id'}" />
                <filter name="group_subscription_product" string="Subscription"
                    context="{'group_by': 'subscription_product_id'}" />
            </xpath>
        </field>
    </record>

    <record id="res_partner_tree_view" model="ir.ui.view">
        <field name="name">res.partner.tree (mozaik_membership)</field>
        <field name="model">res.partner</field>
        <field name="inherit_id" ref="base.view_partner_tree" />
        <field name="arch" type="xml">
            <field name="country_id" position="before">
                <field name="membership_state_id" invisible="context.get('default_is_company')" />
                <field name="local_only"/>
            </field>

        </field>
    </record>

    <record id="res_partner_form_view" model="ir.ui.view">
        <field name="name">res.partner.form (mozaik_membership)</field>
        <field name="model">res.partner</field>
        <field name="inherit_id" ref="base.view_partner_form" />
        <field name="priority" eval="25" />
        <field name="arch" type="xml">
            <field name="postal_coordinate_id" position="after">
                <field name="force_int_instance_id" attrs="{'invisible': [('membership_state_code','not in',[False, 'without_membership'])], 'required': [('int_instance_ids', '=', False)]}" />
                <field name="int_instance_ids" widget="many2many_tags"  attrs="{'invisible': [('membership_state_code','in',[False, 'without_membership'])]}"/>
                <field name="local_only" attrs="{'invisible': ['|', ('is_assembly','=',True), ('membership_state_code', 'not in', [False, 'without_membership', 'former_supporter', 'break_former_member', 'resignation_former_member'])]}"/>
            </field>

            <xpath expr="//field[@name='identifier']" position="after">
                <span attrs="{'invisible':['|', ('is_company', '=', True), ('membership_state_id', '=', False)]}">
                    (
                    <field name="membership_state_id"
                        readonly="1" class="oe_inline" />
                    )
                    <span attrs="{'invisible': [('membership_state_code', 'not in', ['former_supporter', 'refused_member_candidate', 'expulsion_former_member', 'resignation_former_member', 'inappropriate_former_member', 'break_former_member'])]}">
                        <br/>
                        <label class="oe_attention" string="â‡’ Pay Attention"/>
                    </span>
                </span>
            </xpath>

            <xpath expr="//group[@name='moreinfo']" position="inside">
                <field name="kind" />
                <field name="free_member" />
                <field name="membership_state_code" />
                <field name="accepted_date" />
                <field name="decline_payment_date" />
                <field name="rejected_date" />
                <field name="resignation_date" />
                <field name="exclusion_date" />
            </xpath>

            <xpath expr="//field[@name='partner_involvement_ids']/tree" position="inside">
                <field name="amount" sum="1"/>
                <field name="promise" invisible="1"/>
            </xpath>

            <xpath expr="//field[@name='partner_involvement_ids']/tree" position="attributes">
                <attribute name="decoration-danger" translation="off">promise==True</attribute>
            </xpath>

            <notebook position="inside">
                <page name="memberships" string="Memberships">
                    <div name="state_management">

                        <button name="action_add_membership" string="Add subscription" type="object"/>

                        <button name="member_candidate" string="Member candidate" type="object"
                            groups="base.group_erp_manager"
                            attrs="{'invisible': [('membership_state_code', 'not in', ['supporter', 'without_membership', 'refused_member_candidate'])]}"
                            confirm="Set as member candidate: proceed anyway?" />

                        <button name="supporter" string="Supporter" type="object"
                            groups="base.group_erp_manager"
                            attrs="{'invisible': [('membership_state_code', 'not in', ['without_membership', 'member_candidate', 'refused_member_candidate'])]}"
                            confirm="Set as supporter: proceed anyway?" />

                        <button name="accept" string="Accept" type="object"
                            groups="base.group_erp_manager"
                            attrs="{'invisible': [('membership_state_code', 'not in', ['member_committee', 'former_member_committee'])]}" />

                        <button name="register_free_membership" string="Free Membership" type="object"
                            groups="mozaik_membership.res_groups_membership_user"
                            attrs="{'invisible': ['|', ('membership_state_code', 'not in', ['member_candidate', 'member', 'supporter', 'former_member']), ('reference', '=', False)]}"
                            confirm="Register a free membership: proceed anyway?" />

                        <button name="paid" string="Paid" type="object"
                            groups="base.group_erp_manager"
                            attrs="{'invisible': [('membership_state_code', 'not in', ['member_candidate', 'member', 'supporter', 'former_member']),]}" />

                        <button name="decline_payment" string="Decline Payment" type="object"
                            groups="mozaik_membership.res_groups_membership_user"
                            confirm="Decline membership payment request: proceed anyway?"
                            attrs="{'invisible': ['|', ('membership_state_code', 'not in', ['member_candidate', 'member']), ('reference', '=', False)]}" />

                        <button name="reject" string="Reject" type="object"
                            groups="mozaik_membership.res_groups_membership_user"
                            confirm="Reject member candidate: proceed anyway?"
                            attrs="{'invisible': [('membership_state_code', 'not in', ['member_candidate', 'member_committee'])]}" />

                        <button id="exclude_former" name="exclude" string="Exclude" type="object"
                            groups="mozaik_membership.res_groups_membership_user"
                            confirm="Exclude former member: proceed anyway?"
                            attrs="{'invisible': [('membership_state_code', 'not in', ['former_member', 'former_member_committee'])]}" />

                        <button id="exclude_member" name="exclude" string="Exclude" type="object"
                            groups="mozaik_membership.res_groups_membership_user"
                            confirm="Exclude member: proceed anyway?"
                            attrs="{'invisible': [('membership_state_code', 'not in', ['member'])]}" />

                        <button name="resign" string="Resign" type="object"
                            groups="mozaik_membership.res_groups_membership_user"
                            confirm="Resign person: proceed anyway?"
                            attrs="{'invisible': [('membership_state_code', 'not in', ['member', 'former_member', 'supporter'])]}" />

                        <button name="reset" string="Reset" type="object"
                            groups="mozaik_membership.res_groups_membership_user"
                            confirm="Reset membership state: proceed anyway?"
                            attrs="{'invisible': [('membership_state_code', 'not in', ['former_supporter', 'resignation_former_member', 'break_former_member', 'inappropriate_former_member', 'expulsion_former_member'])]}" />

                    </div>
                    <group name="membership_data">
                        <group name="membership_subscription">
                            <field name="subscription_product_id"
                                widget="selection"
                                attrs="{'invisible': [('subscription_product_id', '=', False)]}"/>
                            <field name="reference"
                                attrs="{'invisible': [('reference', '=', False)]}"
                                readonly="1" />
                            <field name="amount"
                                attrs="{'invisible': [('amount', '=', 0.0)]}"/>
                        </group>
                        <group name="voluntary" attrs="{'invisible': [('membership_state_code', 'in', ['supporter', 'former_supporter'])]}">
                            <field name="local_voluntary"/>
                            <field name="regional_voluntary"/>
                            <field name="national_voluntary"/>
                        </group>
                    </group>
                    <field name="membership_line_ids">
                        <tree decoration-muted="active==False" decoration-success="state_code=='member'" decoration-danger="state_code in ['former_supporter', 'refused_member_candidate', 'expulsion_former_member', 'resignation_former_member', 'inappropriate_former_member', 'break_former_member']">
                            <field name="int_instance_id" />
                            <field name="state_id" />
                            <field name="product_id"
                                attrs="{'invisible': [('state_code', 'not in', ['member', 'former_member_committee', 'member_committee'])]}"/>
                            <field name="reference" />
                            <field name="date_from" />
                            <field name="date_to" />
                            <field name="active" invisible="1" />
                            <field name="state_code" invisible="1"/>
                            <button name="%(update_membership_product_action)d" string="Update product/price" type="action"/>
                            <button name="%(update_membership_instance_action)d" string="Update instance" type="action"/>
                        </tree>
                    </field>
                    <group name="user" attrs="{'invisible': [('is_company','=', True)]}">
                        <separator string="Internal Instances"/>
                        <field name="int_instance_m2m_ids" widget="many2many_tags"
                            placeholder="Instances..."
                            attrs="{'required': [('user_ids','!=',[]),('membership_state_id','!=',False)]}" />
                    </group>
                </page>
            </notebook>

        </field>
    </record>

</odoo>
